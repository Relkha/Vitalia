<!DOCTYPE html>
<html lang="fr">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vitalia - Tableau de bord des alertes</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&family=Roboto&family=Rufina:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'vitalia_app/css/style.css' %}">
  <link rel="stylesheet" href="{% static 'vitalia_app/css/alertes.css' %}">
</head>
<body>

<header>
  <div class="logo">Vitalia</div>
  <button class="mobile-menu-button">☰</button>
  <nav>
    <ul>
      <li><a href="/">Accueil</a></li>
      <li><a href="/a_propos">À propos</a></li>
      <li><a href="#">Nos services</a></li>
      <li><a href="/contact">Contact</a></li>
      {% if user.is_authenticated and user.is_superuser or user.groups.first.name == "Directeur" or user.groups.first.name == "Responsable du site" %}
      <li><a href="/admin">Admin</a></li>
      {% endif %}
      {% if user.is_authenticated and user.groups.first.name != "Visiteur du site" %}
      <li><a href="{%url 'dashboard'%}">Dashboard</a></li>
      {% endif %}
      {% if user.is_authenticated %}
      <li><a href="{% url 'deconnexion' %}">Déconnexion</a></li>
      {% else %}
      <li><a href="{% url 'connexion' %}">Connexion</a></li>
      {% endif %}
    </ul>
  </nav>
</header>

<main>
  <h1>Tableau de bord des alertes</h1>

  <div class="alert-filters">
    <div class="filter-group">
      <label for="filter-severity">Niveau de gravité :</label>
      <select id="filter-severity">
        <option value="all">Tous</option>
        <option value="high">Haute priorité</option>
        <option value="medium">Moyenne priorité</option>
        <option value="low">Basse priorité</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="filter-type">Type d'alerte :</label>
      <select id="filter-type">
        <option value="all">Tous</option>
        <option value="medical">Médicale</option>
        <option value="security">Sécurité</option>
        <option value="environmental">Environnement</option>
        <option value="device">Équipement</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="filter-status">Statut :</label>
      <select id="filter-status">
        <option value="all">Tous</option>
        <option value="new">Nouvelle</option>
        <option value="in-progress">En cours</option>
        <option value="resolved">Résolue</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="filter-date">Date :</label>
      <select id="filter-date">
        <option value="today">Aujourd'hui</option>
        <option value="week">Cette semaine</option>
        <option value="month">Ce mois</option>
        <option value="all">Toutes les dates</option>
      </select>
    </div>

    <button class="btn-clear-filters">Réinitialiser les filtres</button>
  </div>

  <div class="alert-stats">
    <div class="stat-card stat-high">
      <h3>Alertes critiques</h3>
      <div class="stat-number">{{ high_priority_count }}</div>
    </div>
    <div class="stat-card stat-medium">
      <h3>Alertes moyennes</h3>
      <div class="stat-number">{{ medium_priority_count }}</div>
    </div>
    <div class="stat-card stat-low">
      <h3>Alertes basses</h3>
      <div class="stat-number">{{ low_priority_count }}</div>
    </div>
    <div class="stat-card stat-total">
      <h3>Total des alertes</h3>
      <div class="stat-number">{{ total_alerts_count }}</div>
    </div>
  </div>

  <div class="alerts-list">
    {% if alerts %}
      {% for alert in alerts %}
        <div class="alert-card priority-{{ alert.priority|lower }}" data-type="{{ alert.type }}" data-status="{{ alert.status }}">
          <div class="alert-header">
            <div class="alert-icon">
              {% if alert.type == 'medical' %}
                <i class="icon-medical"></i>
              {% elif alert.type == 'security' %}
                <i class="icon-security"></i>
              {% elif alert.type == 'environmental' %}
                <i class="icon-environmental"></i>
              {% elif alert.type == 'device' %}
                <i class="icon-device"></i>
              {% endif %}
            </div>
            <div class="alert-info">
              <h3>{{ alert.title }}</h3>
              <p class="alert-meta">
                <span class="alert-time">{{ alert.created_at|date:"d/m/Y H:i" }}</span>
                <span class="alert-location">{{ alert.location }}</span>
                <span class="alert-device">{{ alert.device_name }}</span>
              </p>
            </div>
            <div class="alert-priority priority-badge-{{ alert.priority|lower }}">
              {{ alert.get_priority_display }}
            </div>
          </div>
          <div class="alert-body">
            <p>{{ alert.description }}</p>
            {% if alert.resident %}
              <p class="alert-resident">Résident : <strong>{{ alert.resident.user.first_name }} {{ alert.resident.user.last_name }}</strong></p>
            {% endif %}
          </div>
          <div class="alert-actions">
            <button class="btn btn-primary alert-acknowledge" data-id="{{ alert.id }}">
              Prendre en charge
            </button>
            <button class="btn btn-resolve" data-id="{{ alert.id }}">
              Marquer comme résolu
            </button>
            <button class="btn btn-details" data-id="{{ alert.id }}">
              Détails
            </button>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="no-alerts">
        <p>Aucune alerte pour le moment</p>
      </div>
    {% endif %}
  </div>

  <div class="pagination">
    {% if alerts.has_previous %}
      <a href="?page={{ alerts.previous_page_number }}" class="pagination-prev">Précédent</a>
    {% endif %}

    <span class="pagination-current">
      Page {{ alerts.number }} sur {{ alerts.paginator.num_pages }}
    </span>

    {% if alerts.has_next %}
      <a href="?page={{ alerts.next_page_number }}" class="pagination-next">Suivant</a>
    {% endif %}
  </div>
</main>

<div id="alert-detail-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Détails de l'alerte</h2>
    <div id="alert-detail-content">
      <!-- Le contenu sera injecté par JavaScript -->
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" id="modal-acknowledge">Prendre en charge</button>
      <button class="btn" id="modal-resolve">Marquer comme résolu</button>
      <button class="btn" id="modal-close">Fermer</button>
    </div>
  </div>
</div>

<script src="{% static 'vitalia_app/js/alertes.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const menuButton = document.querySelector('.mobile-menu-button');
    const nav = document.querySelector('nav');

    if (menuButton) {
      menuButton.addEventListener('click', function() {
        nav.classList.toggle('active');
      });
    }

    // Initialiser la gestion des alertes
    initAlertManagement();
  });
</script>
// Gestion des alertes
function initAlertManagement() {
  // Gestion des filtres
  const filterSelects = document.querySelectorAll('.alert-filters select');
  const clearFiltersBtn = document.querySelector('.btn-clear-filters');
  const alertCards = document.querySelectorAll('.alert-card');

  // Appliquer les filtres
  filterSelects.forEach(select => {
    select.addEventListener('change', applyFilters);
  });

  // Réinitialiser les filtres
  clearFiltersBtn.addEventListener('click', () => {
    filterSelects.forEach(select => {
      select.value = 'all';
    });
    applyFilters();
  });

  function applyFilters() {
    const severityFilter = document.getElementById('filter-severity').value;
    const typeFilter = document.getElementById('filter-type').value;
    const statusFilter = document.getElementById('filter-status').value;
    const dateFilter = document.getElementById('filter-date').value;

    alertCards.forEach(card => {
      let showCard = true;

      // Vérifier le niveau de priorité
      if (severityFilter !== 'all' && !card.classList.contains(`priority-${severityFilter}`)) {
        showCard = false;
      }

      // Vérifier le type d'alerte
      if (typeFilter !== 'all' && card.dataset.type !== typeFilter) {
        showCard = false;
      }

      // Vérifier le statut
      if (statusFilter !== 'all' && card.dataset.status !== statusFilter) {
        showCard = false;
      }

      // Vérifier la date - cela nécessiterait plus de logique
      // avec les dates réelles des alertes

      // Afficher ou masquer la carte
      card.style.display = showCard ? 'block' : 'none';
    });
  }

  // Gestion des actions sur les alertes
  const acknowledgeButtons = document.querySelectorAll('.alert-acknowledge');
  const resolveButtons = document.querySelectorAll('.btn-resolve');
  const detailButtons = document.querySelectorAll('.btn-details');

  acknowledgeButtons.forEach(button => {
    button.addEventListener('click', function() {
      const alertId = this.dataset.id;
      acknowledgeAlert(alertId);
    });
  });

  resolveButtons.forEach(button => {
    button.addEventListener('click', function() {
      const alertId = this.dataset.id;
      resolveAlert(alertId);
    });
  });

  detailButtons.forEach(button => {
    button.addEventListener('click', function() {
      const alertId = this.dataset.id;
      showAlertDetails(alertId);
    });
  });

  // Gestion du modal
  const modal = document.getElementById('alert-detail-modal');
  const closeBtn = modal.querySelector('.close');
  const modalClose = document.getElementById('modal-close');
  const modalAcknowledge = document.getElementById('modal-acknowledge');
  const modalResolve = document.getElementById('modal-resolve');

  closeBtn.addEventListener('click', closeModal);
  modalClose.addEventListener('click', closeModal);

  modalAcknowledge.addEventListener('click', function() {
    const alertId = this.dataset.id;
    acknowledgeAlert(alertId);
    closeModal();
  });

  modalResolve.addEventListener('click', function() {
    const alertId = this.dataset.id;
    resolveAlert(alertId);
    closeModal();
  });

  function closeModal() {
    modal.style.display = 'none';
  }

  // Fermer le modal quand on clique en dehors
  window.addEventListener('click', function(event) {
    if (event.target === modal) {
      closeModal();
    }
  });

  // Fonctions d'action sur les alertes
  function acknowledgeAlert(alertId) {
    fetch(`/api/alertes/${alertId}/acknowledge/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Mettre à jour l'interface
        const card = document.querySelector(`.alert-card[data-id="${alertId}"]`);
        card.dataset.status = 'in-progress';

        // Notification de succès
        showNotification('Alerte prise en charge avec succès');
      }
    })
    .catch(error => {
      console.error('Erreur:', error);
    });
  }

  function resolveAlert(alertId) {
    fetch(`/api/alertes/${alertId}/resolve/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Mettre à jour l'interface
        const card = document.querySelector(`.alert-card[data-id="${alertId}"]`);
        card.dataset.status = 'resolved';

        // Notification de succès
        showNotification('Alerte marquée comme résolue');
      }
    })
    .catch(error => {
      console.error('Erreur:', error);
    });
  }

  function showAlertDetails(alertId) {
    fetch(`/api/alertes/${alertId}/details/`)
    .then(response => response.json())
    .then(data => {
      const detailContent = document.getElementById('alert-detail-content');

      // Générer le contenu HTML pour les détails
      let html = `
        <div class="alert-detail-header priority-${data.priority}">
          <h3>${data.title}</h3>
          <div class="alert-detail-meta">
            <p><strong>Date et heure :</strong> ${formatDate(data.created_at)}</p>
            <p><strong>Priorité :</strong> ${data.priority_display}</p>
            <p><strong>Type :</strong> ${data.type_display}</p>
            <p><strong>Statut :</strong> ${data.status_display}</p>
          </div>
        </div>
        <div class="alert-detail-body">
          <p>${data.description}</p>
      `;

      if (data.device) {
        html += `
          <div class="detail-section">
            <h4>Informations sur l'appareil</h4>
            <p><strong>Nom :</strong> ${data.device.name}</p>
            <p><strong>Type :</strong> ${data.device.type}</p>
            <p><strong>Emplacement :</strong> ${data.device.location}</p>
          </div>
        `;
      }

      if (data.resident) {
        html += `
          <div class="detail-section">
            <h4>Informations sur le résident</h4>
            <p><strong>Nom :</strong> ${data.resident.first_name} ${data.resident.last_name}</p>
            <p><strong>Chambre :</strong> ${data.resident.room_number || 'Non assignée'}</p>
          </div>
        `;
      }

      if (data.history && data.history.length > 0) {
        html += `
          <div class="detail-section">
            <h4>Historique</h4>
            <ul class="alert-history">
        `;

        data.history.forEach(entry => {
          html += `
            <li>
              <span class="history-date">${formatDate(entry.date)}</span>
              <span class="history-action">${entry.action}</span>
              <span class="history-user">${entry.user}</span>
            </li>
          `;
        });

        html += `
            </ul>
          </div>
        `;
      }

      html += `</div>`;

      // Injecter le HTML dans le modal
      detailContent.innerHTML = html;

      // Mettre à jour les données des boutons du modal
      modalAcknowledge.dataset.id = alertId;
      modalResolve.dataset.id = alertId;

      // Afficher le modal
      modal.style.display = 'block';
    })
    .catch(error => {
      console.error('Erreur:', error);
    });
  }

  // Fonctions utilitaires
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('fr-FR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function showNotification(message) {
    // Créer une notification HTML
    const notification = document.createElement('div');
    notification.className = 'toast-notification';
    notification.textContent = message;

    // Ajouter au document
    document.body.appendChild(notification);

    // Afficher avec animation
    setTimeout(() => {
      notification.classList.add('show');
    }, 10);

    // Supprimer après 3 secondes
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        notification.remove();
      }, 300);
    }, 3000);
  }
}
<footer>
  <p>&copy; 2025 Vitalia. Tous droits réservés. Projet CY Tech.</p>
  <p><small>Conçu avec bienveillance et modernité.</small></p>
</footer>
</body>
</html>